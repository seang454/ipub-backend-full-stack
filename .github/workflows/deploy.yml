name: Deploy to VM

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the workflow repo(for logging / workflow context)
      - name: Checkout workflow repo
        uses: actions/checkout@v3

      # 2️⃣ SSH into VM and deploy and
      - name: SSH into VM and deploy
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.GCE_VM_IP }}
          username: ${{ secrets.GCE_VM_USER }}
          key: ${{ secrets.GCE_SSH_PRIVATE_KEY }}
          script: |
            set -e
            set -o pipefail
            echo "🚀 Starting deployment of docuhub-app..."

            # 0️⃣ Install Java 21 (Temurin JDK) if not installed
            if ! java -version 2>/dev/null | grep -q "21"; then
              echo "☕ Installing JDK 21..."
              sudo apt-get update -y
              sudo apt-get install -y wget apt-transport-https gnupg lsb-release

              # Add Adoptium (Temurin) repo for JDK 21
              wget -qO - https://packages.adoptium.net/artifactory/api/gpg/key/public | sudo apt-key add -
              echo "deb [arch=amd64] https://packages.adoptium.net/artifactory/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/adoptium.list

              sudo apt-get update -y
              sudo apt-get install -y temurin-21-jdk
            fi

            java -version

            # 1️⃣ Clone or update repo
            if [ -d "$HOME/docuhub-api" ]; then
              echo "📂 Repo exists, updating..."
              cd $HOME/docuhub-api
              git fetch origin
              git reset --hard origin/main
            else
              echo "📂 Cloning repo..."
              git clone https://${{ secrets.PAT_TOKEN }}@github.com/seang454/ipub-backend-full-stack.git $HOME/docuhub-api
              cd $HOME/docuhub-api
            fi

            # 2️⃣ Build project with Gradle
            export GRADLE_USER_HOME=$HOME/.gradle
            chmod +x gradlew
            echo "🛠️ Building project..."
            ./gradlew clean build -x test --no-daemon --parallel

            # 3️⃣ Stop and remove old Docker container if exists
            echo "🐳 Stopping old container (if any)..."
            docker stop docuhub-container || true
            docker rm docuhub-container || true

            # 4️⃣ Remove old Docker image
            echo "🗑️ Removing old Docker image (if any)..."
            docker rmi docuhub-app || true

            # 5️⃣ Build new Docker image
            echo "📦 Building new Docker image..."
            docker build -t docuhub-app .

            # 6️⃣ Run new container
            echo "🚀 Running new Docker container..."
            docker run -d -p 8080:8080 --name docuhub-container --restart unless-stopped docuhub-app

            # 7️⃣ Verify deployment
            echo "✅ Deployment finished successfully!"
            docker ps | grep docuhub-container || echo "⚠️ Container not running!"
